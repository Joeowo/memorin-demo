# å¤šç”¨æˆ·å…±äº«çŸ¥è¯†åº“ä¸ä¸ªäººå¤ä¹ çŠ¶æ€åˆ†ç¦»è®¾è®¡

> **è®¾è®¡ç›®æ ‡**: æ”¯æŒå¤šç”¨æˆ·å…±äº«çŸ¥è¯†åº“ï¼ŒåŒæ—¶ä¿æŒä¸ªäººå¤ä¹ çŠ¶æ€ç‹¬ç«‹  
> **æ ¸å¿ƒç†å¿µ**: åˆ†ç¦»çŸ¥è¯†å†…å®¹ä¸å­¦ä¹ çŠ¶æ€ï¼Œå®ç°å†…å®¹å…±äº«ã€çŠ¶æ€éš”ç¦»  
> **è®¾è®¡æ—¶é—´**: 2025-01-08  

## ğŸ¯ é—®é¢˜åˆ†æ

### ç°æœ‰è®¾è®¡é—®é¢˜
```sql
-- âŒ é—®é¢˜è®¾è®¡ï¼šçŸ¥è¯†ç‚¹ç»‘å®šç”¨æˆ·ï¼Œæ— æ³•å…±äº«
CREATE TABLE knowledge_points (
    id BIGINT PRIMARY KEY,
    user_id BIGINT NOT NULL,  -- ç»‘å®šç”¨æˆ·ï¼Œå¯¼è‡´æ— æ³•å…±äº«
    question TEXT,
    answer TEXT
);
```

### å®é™…éœ€æ±‚åœºæ™¯
1. **å…¬å…±çŸ¥è¯†åº“**: è½¯ä»¶å·¥ç¨‹ã€æ•°å­¦ã€è‹±è¯­ç­‰æ ‡å‡†çŸ¥è¯†åº“
2. **å†…å®¹å…±äº«**: å¤šä¸ªç”¨æˆ·ä½¿ç”¨ç›¸åŒçš„çŸ¥è¯†ç‚¹å†…å®¹
3. **çŠ¶æ€ç‹¬ç«‹**: æ¯ä¸ªç”¨æˆ·å¯¹ç›¸åŒçŸ¥è¯†ç‚¹æœ‰ä¸åŒçš„å¤ä¹ è¿›åº¦
4. **æƒé™ç®¡ç†**: æ”¯æŒå…¬å¼€ã€ç§æœ‰ã€åä½œç­‰ä¸åŒæƒé™æ¨¡å¼

## ğŸ—ï¸ é‡æ–°è®¾è®¡çš„æ•°æ®æ¨¡å‹

### 1. çŸ¥è¯†ç‚¹å†…å®¹è¡¨ï¼ˆå…±äº«ï¼‰
```sql
-- çŸ¥è¯†ç‚¹å†…å®¹è¡¨ï¼šä¸ç»‘å®šç”¨æˆ·ï¼Œæ”¯æŒå…±äº«
CREATE TABLE knowledge_point_contents (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    content_hash VARCHAR(64) UNIQUE NOT NULL COMMENT 'å†…å®¹å“ˆå¸Œï¼Œç”¨äºå»é‡',
    
    -- åŸºç¡€å†…å®¹ä¿¡æ¯
    type ENUM('fill', 'choice') NOT NULL DEFAULT 'fill',
    question TEXT NOT NULL,
    answer TEXT NOT NULL,
    explanation TEXT,
    
    -- é€‰æ‹©é¢˜ç‰¹æœ‰å­—æ®µ
    choice_type ENUM('single', 'multiple'),
    options JSON,
    correct_answer VARCHAR(50),
    
    -- å…ƒæ•°æ®
    tags JSON COMMENT 'æ ‡ç­¾æ•°ç»„',
    difficulty TINYINT DEFAULT 3 COMMENT 'å»ºè®®éš¾åº¦ 1-5',
    estimated_time INT COMMENT 'é¢„ä¼°ç­”é¢˜æ—¶é—´ï¼ˆç§’ï¼‰',
    source VARCHAR(100) COMMENT 'æ¥æºæ ‡è¯†',
    
    -- åˆ›å»ºä¿¡æ¯
    created_by BIGINT COMMENT 'åˆ›å»ºè€…ç”¨æˆ·ID',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    -- ç»Ÿè®¡ä¿¡æ¯
    usage_count INT DEFAULT 0 COMMENT 'è¢«ä½¿ç”¨æ¬¡æ•°',
    avg_difficulty DECIMAL(3,1) COMMENT 'å®é™…å¹³å‡éš¾åº¦',
    
    -- ç´¢å¼•
    INDEX idx_created_by (created_by),
    INDEX idx_difficulty (difficulty),
    INDEX idx_type (type),
    INDEX idx_created_at (created_at),
    FULLTEXT INDEX ft_content (question, answer, explanation)
) COMMENT='çŸ¥è¯†ç‚¹å†…å®¹è¡¨ï¼ˆå…±äº«ï¼‰';
```

### 2. ç”¨æˆ·çŸ¥è¯†ç‚¹çŠ¶æ€è¡¨ï¼ˆä¸ªäººï¼‰
```sql
-- ç”¨æˆ·å¯¹çŸ¥è¯†ç‚¹çš„ä¸ªäººå­¦ä¹ çŠ¶æ€
CREATE TABLE user_knowledge_point_states (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    content_id BIGINT NOT NULL COMMENT 'å…³è”çŸ¥è¯†ç‚¹å†…å®¹ID',
    
    -- ä¸ªäººå¤ä¹ çŠ¶æ€
    mastery_level TINYINT DEFAULT 1 COMMENT 'æŒæ¡ç¨‹åº¦ 1-5',
    review_count INT DEFAULT 0 COMMENT 'å¤ä¹ æ¬¡æ•°',
    correct_count INT DEFAULT 0 COMMENT 'æ­£ç¡®æ¬¡æ•°',
    consecutive_correct INT DEFAULT 0 COMMENT 'è¿ç»­æ­£ç¡®æ¬¡æ•°',
    
    -- SM-2ç®—æ³•æ•°æ®
    easiness_factor DECIMAL(3,2) DEFAULT 2.5 COMMENT 'SM-2ç®—æ³•éš¾åº¦å› å­',
    repetition_number INT DEFAULT 0 COMMENT 'SM-2ç®—æ³•é‡å¤æ¬¡æ•°',
    inter_repetition_interval INT DEFAULT 1 COMMENT 'SM-2ç®—æ³•é—´éš”å¤©æ•°',
    
    -- æ—¶é—´ä¿¡æ¯
    first_learned_at TIMESTAMP NULL COMMENT 'é¦–æ¬¡å­¦ä¹ æ—¶é—´',
    last_reviewed_at TIMESTAMP NULL COMMENT 'æœ€åå¤ä¹ æ—¶é—´',
    next_review_at TIMESTAMP NULL COMMENT 'ä¸‹æ¬¡å¤ä¹ æ—¶é—´',
    
    -- ä¸ªäººå®šåˆ¶
    personal_difficulty TINYINT COMMENT 'ä¸ªäººæ„ŸçŸ¥éš¾åº¦ 1-5',
    personal_tags JSON COMMENT 'ä¸ªäººæ ‡ç­¾',
    personal_notes TEXT COMMENT 'ä¸ªäººç¬”è®°',
    is_bookmarked BOOLEAN DEFAULT FALSE COMMENT 'æ˜¯å¦æ”¶è—',
    is_hidden BOOLEAN DEFAULT FALSE COMMENT 'æ˜¯å¦éšè—',
    
    -- æ€§èƒ½æ•°æ®
    avg_response_time INT COMMENT 'å¹³å‡å“åº”æ—¶é—´ï¼ˆç§’ï¼‰',
    fastest_time INT COMMENT 'æœ€å¿«ç­”é¢˜æ—¶é—´',
    slowest_time INT COMMENT 'æœ€æ…¢ç­”é¢˜æ—¶é—´',
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    -- å”¯ä¸€çº¦æŸå’Œç´¢å¼•
    UNIQUE KEY uk_user_content (user_id, content_id),
    INDEX idx_mastery_level (mastery_level),
    INDEX idx_next_review (next_review_at),
    INDEX idx_user_mastery (user_id, mastery_level),
    INDEX idx_content_users (content_id),
    
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (content_id) REFERENCES knowledge_point_contents(id) ON DELETE CASCADE
) COMMENT='ç”¨æˆ·çŸ¥è¯†ç‚¹å­¦ä¹ çŠ¶æ€è¡¨';
```

### 3. é‡æ–°è®¾è®¡çš„çŸ¥è¯†åº“å…³è”è¡¨
```sql
-- çŸ¥è¯†åº“ä¸çŸ¥è¯†ç‚¹å†…å®¹çš„å…³è”ï¼ˆæ”¯æŒå¤šç”¨æˆ·å…±äº«ï¼‰
CREATE TABLE knowledge_base_content_relations (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    knowledge_base_id BIGINT NOT NULL,
    content_id BIGINT NOT NULL,
    
    -- åœ¨çŸ¥è¯†åº“ä¸­çš„å±æ€§
    category VARCHAR(50),
    sort_order INT DEFAULT 0,
    weight DECIMAL(3,2) DEFAULT 1.0 COMMENT 'æƒé‡',
    
    -- ç®¡ç†ä¿¡æ¯
    added_by BIGINT NOT NULL COMMENT 'æ·»åŠ è€…ç”¨æˆ·ID',
    added_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    -- å”¯ä¸€çº¦æŸ
    UNIQUE KEY uk_base_content (knowledge_base_id, content_id),
    INDEX idx_base_category (knowledge_base_id, category),
    INDEX idx_content_bases (content_id),
    INDEX idx_added_by (added_by),
    
    FOREIGN KEY (knowledge_base_id) REFERENCES knowledge_bases(id) ON DELETE CASCADE,
    FOREIGN KEY (content_id) REFERENCES knowledge_point_contents(id) ON DELETE CASCADE,
    FOREIGN KEY (added_by) REFERENCES users(id)
) COMMENT='çŸ¥è¯†åº“-å†…å®¹å…³è”è¡¨';
```

### 4. é‡æ–°è®¾è®¡çš„çŸ¥è¯†åŒºå…³è”è¡¨
```sql
-- çŸ¥è¯†åŒºä¸çŸ¥è¯†ç‚¹å†…å®¹çš„å…³è”
CREATE TABLE knowledge_area_content_relations (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    knowledge_area_id BIGINT NOT NULL,
    content_id BIGINT NOT NULL,
    
    -- å…³è”å±æ€§
    relevance_score DECIMAL(3,2) DEFAULT 1.0,
    sort_order INT DEFAULT 0,
    
    -- ç®¡ç†ä¿¡æ¯
    added_by BIGINT NOT NULL,
    added_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    UNIQUE KEY uk_area_content (knowledge_area_id, content_id),
    INDEX idx_area_relevance (knowledge_area_id, relevance_score),
    INDEX idx_content_areas (content_id),
    
    FOREIGN KEY (knowledge_area_id) REFERENCES knowledge_areas(id) ON DELETE CASCADE,
    FOREIGN KEY (content_id) REFERENCES knowledge_point_contents(id) ON DELETE CASCADE,
    FOREIGN KEY (added_by) REFERENCES users(id)
) COMMENT='çŸ¥è¯†åŒº-å†…å®¹å…³è”è¡¨';
```

### 5. æ›´æ–°çš„çŸ¥è¯†åº“è¡¨ï¼ˆæ”¯æŒå…±äº«ï¼‰
```sql
-- æ›´æ–°çŸ¥è¯†åº“è¡¨ï¼Œæ”¯æŒå…±äº«æ¨¡å¼
CREATE TABLE knowledge_bases (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    owner_id BIGINT NOT NULL COMMENT 'æ‰€æœ‰è€…ç”¨æˆ·ID',
    name VARCHAR(100) NOT NULL,
    description TEXT,
    icon VARCHAR(50) DEFAULT 'ğŸ“š',
    color VARCHAR(20) DEFAULT '#667eea',
    category VARCHAR(50),
    
    -- å…±äº«è®¾ç½®
    visibility ENUM('private', 'public', 'shared') DEFAULT 'private' COMMENT 'å¯è§æ€§',
    is_official BOOLEAN DEFAULT FALSE COMMENT 'æ˜¯å¦å®˜æ–¹çŸ¥è¯†åº“',
    allow_fork BOOLEAN DEFAULT TRUE COMMENT 'å…è®¸å¤åˆ¶',
    allow_contribute BOOLEAN DEFAULT FALSE COMMENT 'å…è®¸åä½œ',
    
    -- ç»Ÿè®¡ä¿¡æ¯
    content_count INT DEFAULT 0 COMMENT 'å†…å®¹æ•°é‡',
    subscriber_count INT DEFAULT 0 COMMENT 'è®¢é˜…ç”¨æˆ·æ•°',
    fork_count INT DEFAULT 0 COMMENT 'è¢«å¤åˆ¶æ¬¡æ•°',
    
    sort_order INT DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_owner_visibility (owner_id, visibility),
    INDEX idx_public_official (visibility, is_official),
    INDEX idx_category (category),
    
    FOREIGN KEY (owner_id) REFERENCES users(id) ON DELETE CASCADE
) COMMENT='çŸ¥è¯†åº“è¡¨ï¼ˆæ”¯æŒå…±äº«ï¼‰';
```

### 6. ç”¨æˆ·çŸ¥è¯†åº“è®¢é˜…è¡¨
```sql
-- ç”¨æˆ·è®¢é˜…çŸ¥è¯†åº“çš„è®°å½•
CREATE TABLE user_knowledge_base_subscriptions (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    knowledge_base_id BIGINT NOT NULL,
    
    -- è®¢é˜…è®¾ç½®
    role ENUM('viewer', 'contributor', 'admin') DEFAULT 'viewer',
    is_active BOOLEAN DEFAULT TRUE,
    
    -- ä¸ªäººè®¾ç½®
    personal_name VARCHAR(100) COMMENT 'ä¸ªäººé‡å‘½å',
    personal_color VARCHAR(20) COMMENT 'ä¸ªäººé¢œè‰²',
    sort_order INT DEFAULT 0,
    
    subscribed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_accessed_at TIMESTAMP NULL,
    
    UNIQUE KEY uk_user_base (user_id, knowledge_base_id),
    INDEX idx_user_active (user_id, is_active),
    INDEX idx_base_subscribers (knowledge_base_id),
    INDEX idx_role (role),
    
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (knowledge_base_id) REFERENCES knowledge_bases(id) ON DELETE CASCADE
) COMMENT='ç”¨æˆ·çŸ¥è¯†åº“è®¢é˜…è¡¨';
```

## ğŸ“Š æ ¸å¿ƒæŸ¥è¯¢ç¤ºä¾‹

### 1. è·å–ç”¨æˆ·çš„çŸ¥è¯†ç‚¹å­¦ä¹ çŠ¶æ€
```sql
-- æŸ¥è¯¢ç”¨æˆ·å¯¹ç‰¹å®šçŸ¥è¯†åº“çš„å­¦ä¹ è¿›åº¦
SELECT 
    kpc.id as content_id,
    kpc.question,
    kpc.difficulty as suggested_difficulty,
    ukps.mastery_level,
    ukps.review_count,
    ukps.correct_count,
    ukps.personal_difficulty,
    ukps.next_review_at,
    CASE 
        WHEN ukps.mastery_level >= 4 THEN 'mastered'
        WHEN ukps.next_review_at <= NOW() THEN 'due'
        ELSE 'learning'
    END as status
FROM knowledge_point_contents kpc
JOIN knowledge_base_content_relations kbcr ON kpc.id = kbcr.content_id
LEFT JOIN user_knowledge_point_states ukps ON kpc.id = ukps.content_id 
    AND ukps.user_id = ?
WHERE kbcr.knowledge_base_id = ?
ORDER BY ukps.next_review_at ASC NULLS FIRST;
```

### 2. å¤šç”¨æˆ·å…±äº«çŸ¥è¯†åº“çš„ç»Ÿè®¡
```sql
-- æŸ¥è¯¢çŸ¥è¯†åº“çš„å¤šç”¨æˆ·ä½¿ç”¨ç»Ÿè®¡
SELECT 
    kb.name as knowledge_base_name,
    COUNT(DISTINCT ukbs.user_id) as subscriber_count,
    COUNT(DISTINCT kbcr.content_id) as content_count,
    AVG(ukps.mastery_level) as avg_mastery_level,
    COUNT(DISTINCT CASE WHEN ukps.mastery_level >= 4 THEN ukps.user_id END) as mastered_users,
    COUNT(DISTINCT CASE WHEN ukps.next_review_at <= NOW() THEN ukps.user_id END) as users_with_due_reviews
FROM knowledge_bases kb
JOIN user_knowledge_base_subscriptions ukbs ON kb.id = ukbs.knowledge_base_id
JOIN knowledge_base_content_relations kbcr ON kb.id = kbcr.knowledge_base_id
LEFT JOIN user_knowledge_point_states ukps ON kbcr.content_id = ukps.content_id 
    AND ukbs.user_id = ukps.user_id
WHERE kb.id = ?
GROUP BY kb.id;
```

### 3. ç”¨æˆ·ä¸ªäººåŒ–å¤ä¹ é˜Ÿåˆ—
```sql
-- ç”Ÿæˆç”¨æˆ·çš„ä¸ªäººå¤ä¹ é˜Ÿåˆ—
SELECT 
    kpc.id,
    kpc.question,
    kpc.type,
    ukps.mastery_level,
    ukps.next_review_at,
    ukps.consecutive_correct,
    kb.name as knowledge_base_name,
    ka.name as knowledge_area_name,
    -- è®¡ç®—å¤ä¹ ä¼˜å…ˆçº§
    CASE 
        WHEN ukps.next_review_at <= NOW() - INTERVAL 1 DAY THEN 5  -- é€¾æœŸ
        WHEN ukps.next_review_at <= NOW() THEN 4                   -- åˆ°æœŸ
        WHEN ukps.mastery_level < 3 THEN 3                         -- æœªæŒæ¡
        WHEN ukps.consecutive_correct = 0 THEN 2                   -- æœ€è¿‘é”™è¯¯
        ELSE 1                                                     -- æ­£å¸¸
    END as priority
FROM user_knowledge_point_states ukps
JOIN knowledge_point_contents kpc ON ukps.content_id = kpc.id
JOIN knowledge_base_content_relations kbcr ON kpc.id = kbcr.content_id
JOIN knowledge_bases kb ON kbcr.knowledge_base_id = kb.id
LEFT JOIN knowledge_area_content_relations kacr ON kpc.id = kacr.content_id
LEFT JOIN knowledge_areas ka ON kacr.knowledge_area_id = ka.id
WHERE ukps.user_id = ?
    AND ukps.is_hidden = FALSE
    AND ukps.next_review_at <= NOW() + INTERVAL 1 DAY
ORDER BY priority DESC, ukps.next_review_at ASC
LIMIT 50;
```

## ğŸ”„ æ•°æ®è¿ç§»ç­–ç•¥

### ä»æ—§æ¨¡å‹è¿ç§»
```sql
-- æ­¥éª¤1: è¿ç§»çŸ¥è¯†ç‚¹å†…å®¹ï¼ˆå»é‡åˆå¹¶ï¼‰
INSERT INTO knowledge_point_contents (
    content_hash, type, question, answer, explanation, 
    difficulty, tags, created_by, created_at
)
SELECT 
    SHA2(CONCAT(question, answer), 256) as content_hash,
    type, question, answer, explanation,
    difficulty, tags, user_id, created_at
FROM old_knowledge_points
ON DUPLICATE KEY UPDATE usage_count = usage_count + 1;

-- æ­¥éª¤2: åˆ›å»ºç”¨æˆ·å­¦ä¹ çŠ¶æ€è®°å½•
INSERT INTO user_knowledge_point_states (
    user_id, content_id, review_count, correct_count,
    last_reviewed_at, next_review_at, created_at
)
SELECT 
    okp.user_id,
    kpc.id as content_id,
    COALESCE(rd.review_count, 0),
    COALESCE(rd.correct_count, 0),
    rd.last_reviewed_at,
    rd.next_review_at,
    okp.created_at
FROM old_knowledge_points okp
JOIN knowledge_point_contents kpc ON SHA2(CONCAT(okp.question, okp.answer), 256) = kpc.content_hash
LEFT JOIN old_review_data rd ON okp.id = rd.knowledge_point_id;

-- æ­¥éª¤3: è¿ç§»çŸ¥è¯†åº“å…³è”
INSERT INTO knowledge_base_content_relations (
    knowledge_base_id, content_id, added_by, added_at
)
SELECT DISTINCT
    okp.knowledge_base_id,
    kpc.id as content_id,
    okp.user_id as added_by,
    okp.created_at as added_at
FROM old_knowledge_points okp
JOIN knowledge_point_contents kpc ON SHA2(CONCAT(okp.question, okp.answer), 256) = kpc.content_hash
WHERE okp.knowledge_base_id IS NOT NULL;
```

## ğŸ¯ åº”ç”¨å±‚é€‚é…

### 1. APIæ¥å£è®¾è®¡
```typescript
// è·å–ç”¨æˆ·çš„çŸ¥è¯†åº“å­¦ä¹ çŠ¶æ€
interface UserKnowledgeBaseProgress {
  knowledgeBaseId: number;
  knowledgeBaseName: string;
  totalContents: number;
  learnedContents: number;
  masteredContents: number;
  dueContents: number;
  progressPercentage: number;
  estimatedReviewTime: number;
}

// GET /api/users/{userId}/knowledge-bases/progress
interface UserProgressResponse {
  success: boolean;
  data: {
    subscribedBases: UserKnowledgeBaseProgress[];
    totalProgress: {
      totalContents: number;
      masteredContents: number;
      overallProgress: number;
    };
  };
}

// è·å–å…±äº«çŸ¥è¯†åº“ä¿¡æ¯
interface SharedKnowledgeBase {
  id: number;
  name: string;
  description: string;
  owner: UserInfo;
  visibility: 'public' | 'shared';
  isOfficial: boolean;
  contentCount: number;
  subscriberCount: number;
  avgDifficulty: number;
  categories: string[];
}

// GET /api/knowledge-bases/public
interface PublicKnowledgeBasesResponse {
  success: boolean;
  data: {
    official: SharedKnowledgeBase[];
    community: SharedKnowledgeBase[];
    recommended: SharedKnowledgeBase[];
  };
}
```

### 2. Vueç»„ä»¶è®¾è®¡
```vue
<template>
  <div class="knowledge-base-browser">
    <!-- æˆ‘çš„çŸ¥è¯†åº“ -->
    <div class="my-knowledge-bases">
      <h3>æˆ‘çš„çŸ¥è¯†åº“</h3>
      <KnowledgeBaseCard
        v-for="base in myBases"
        :key="base.id"
        :knowledge-base="base"
        :progress="getUserProgress(base.id)"
        @start-review="startReview"
        @manage="manageBase"
      />
    </div>
    
    <!-- å…¬å…±çŸ¥è¯†åº“ -->
    <div class="public-knowledge-bases">
      <h3>å…¬å…±çŸ¥è¯†åº“</h3>
      <SharedKnowledgeBaseCard
        v-for="base in publicBases"
        :key="base.id"
        :knowledge-base="base"
        :is-subscribed="isSubscribed(base.id)"
        @subscribe="subscribeBase"
        @preview="previewBase"
      />
    </div>
    
    <!-- ä¸ªäººå­¦ä¹ çŠ¶æ€ -->
    <PersonalLearningStatus
      :user-id="currentUserId"
      :knowledge-bases="allSubscribedBases"
    />
  </div>
</template>

<script setup lang="ts">
interface PersonalLearningState {
  contentId: number;
  masteryLevel: number;
  reviewCount: number;
  nextReviewAt: Date;
  personalDifficulty?: number;
  personalNotes?: string;
  isBookmarked: boolean;
}

const userStates = ref<Map<number, PersonalLearningState>>(new Map());

// è·å–ç”¨æˆ·å¯¹ç‰¹å®šå†…å®¹çš„å­¦ä¹ çŠ¶æ€
const getUserState = (contentId: number): PersonalLearningState | null => {
  return userStates.value.get(contentId) || null;
};

// æ›´æ–°å­¦ä¹ çŠ¶æ€
const updateLearningState = async (contentId: number, updates: Partial<PersonalLearningState>) => {
  const currentState = getUserState(contentId);
  const newState = { ...currentState, ...updates };
  
  await api.updateUserKnowledgeState(currentUserId.value, contentId, newState);
  userStates.value.set(contentId, newState);
};
</script>
```

## âš¡ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 1. ç¼“å­˜ç­–ç•¥
```typescript
// Redisç¼“å­˜è®¾è®¡
interface CacheKeys {
  // ç”¨æˆ·å­¦ä¹ çŠ¶æ€ç¼“å­˜ï¼ˆçƒ­æ•°æ®ï¼‰
  userStates: `user:${userId}:states`;           // è¿‡æœŸæ—¶é—´: 1å°æ—¶
  
  // çŸ¥è¯†åº“å†…å®¹ç¼“å­˜
  knowledgeBaseContents: `kb:${baseId}:contents`; // è¿‡æœŸæ—¶é—´: 24å°æ—¶
  
  // ç”¨æˆ·å¤ä¹ é˜Ÿåˆ—ç¼“å­˜
  userReviewQueue: `user:${userId}:review:queue`; // è¿‡æœŸæ—¶é—´: 30åˆ†é’Ÿ
  
  // å…¬å…±çŸ¥è¯†åº“åˆ—è¡¨ç¼“å­˜
  publicKnowledgeBases: 'kb:public:list';         // è¿‡æœŸæ—¶é—´: 6å°æ—¶
}

// ç¼“å­˜æ›´æ–°ç­–ç•¥
class LearningStateCache {
  async updateUserState(userId: number, contentId: number, state: PersonalLearningState) {
    // æ›´æ–°æ•°æ®åº“
    await db.updateUserKnowledgeState(userId, contentId, state);
    
    // æ›´æ–°ç¼“å­˜
    const cacheKey = `user:${userId}:states`;
    await redis.hset(cacheKey, contentId.toString(), JSON.stringify(state));
    
    // å¦‚æœå¤ä¹ çŠ¶æ€å˜åŒ–ï¼Œæ¸…é™¤å¤ä¹ é˜Ÿåˆ—ç¼“å­˜
    if (state.nextReviewAt) {
      await redis.del(`user:${userId}:review:queue`);
    }
  }
}
```

### 2. åˆ†ç‰‡ç­–ç•¥
```sql
-- æŒ‰ç”¨æˆ·IDå¯¹å­¦ä¹ çŠ¶æ€è¡¨è¿›è¡Œåˆ†ç‰‡
CREATE TABLE user_knowledge_point_states_shard_0 LIKE user_knowledge_point_states;
CREATE TABLE user_knowledge_point_states_shard_1 LIKE user_knowledge_point_states;
CREATE TABLE user_knowledge_point_states_shard_2 LIKE user_knowledge_point_states;
CREATE TABLE user_knowledge_point_states_shard_3 LIKE user_knowledge_point_states;

-- åˆ†ç‰‡è·¯ç”±å‡½æ•°
DELIMITER $$
CREATE FUNCTION GetUserStateShardTable(p_user_id BIGINT) 
RETURNS VARCHAR(100)
READS SQL DATA
DETERMINISTIC
BEGIN
    DECLARE shard_suffix INT;
    SET shard_suffix = p_user_id % 4;
    RETURN CONCAT('user_knowledge_point_states_shard_', shard_suffix);
END$$
DELIMITER ;
```

---

**æ€»ç»“**: è¿™ä¸ªé‡æ–°è®¾è®¡çš„æ¨¡å‹å®Œç¾è§£å†³äº†å¤šç”¨æˆ·å…±äº«çŸ¥è¯†åº“çš„é—®é¢˜ï¼š

1. **å†…å®¹å…±äº«**: `knowledge_point_contents`è¡¨ä¸ç»‘å®šç”¨æˆ·ï¼Œæ”¯æŒå¤šç”¨æˆ·å…±äº«ç›¸åŒå†…å®¹
2. **çŠ¶æ€éš”ç¦»**: `user_knowledge_point_states`è¡¨è®°å½•æ¯ä¸ªç”¨æˆ·çš„ä¸ªäººå­¦ä¹ çŠ¶æ€
3. **çµæ´»æƒé™**: æ”¯æŒç§æœ‰ã€å…¬å¼€ã€åä½œç­‰å¤šç§çŸ¥è¯†åº“å…±äº«æ¨¡å¼
4. **æ€§èƒ½ä¼˜åŒ–**: é€šè¿‡åˆ†ç‰‡å’Œç¼“å­˜ç­–ç•¥æ”¯æŒå¤§è§„æ¨¡ç”¨æˆ·ä½¿ç”¨

ç°åœ¨åŒä¸€ä¸ªçŸ¥è¯†ç‚¹å¯ä»¥è¢«å¤šä¸ªç”¨æˆ·ä½¿ç”¨ï¼Œä½†æ¯ä¸ªç”¨æˆ·çš„å¤ä¹ è¿›åº¦ã€æŒæ¡ç¨‹åº¦ã€ä¸ªäººç¬”è®°ç­‰éƒ½æ˜¯å®Œå…¨ç‹¬ç«‹çš„ï¼ 