# Memorin 微服务架构设计文档

## 项目概述

### 项目背景
基于当前的静态网页demo（Memorin智能知识复习系统），扩展为前后端分离+微服务架构的软件平台。保持前端技术栈不变，后端采用Spring Boot微服务架构，数据库使用MySQL + Redis。

### 技术栈选型
- **前端**: HTML5 + CSS3 + JavaScript ES6+ (保持与demo一致)
- **后端**: Spring Boot + Spring Cloud + MyBatis-Plus
- **数据库**: MySQL 8.0 + Redis 6.0
- **服务注册**: Nacos
- **网关**: Spring Cloud Gateway
- **容器化**: Docker + Docker Compose
- **消息队列**: RabbitMQ
- **监控**: Spring Boot Admin

## 当前Demo功能分析

### 核心功能模块
1. **知识管理模块** - 三级结构：知识库→知识区→知识点
2. **复习系统模块** - 题目生成器+智能复习算法+答题界面
3. **错题本模块** - 错题记录+分类管理+掌握度追踪
4. **用户数据模块** - 本地存储+数据统计
5. **评分系统模块** - 自主评分+复习调度

### Demo实现特点分析
- **数据存储**: 基于LocalStorage的纯前端存储
- **算法实现**: 前端JavaScript实现SM-2算法
- **题目生成**: 前端策略模式实现题目列表生成器
- **状态管理**: 前端内存状态管理
- **用户体验**: 无需登录，即开即用

## 微服务架构设计

### 服务拆分原则
1. **业务边界清晰** - 按业务功能垂直拆分
2. **数据独立性** - 每个服务管理自己的数据
3. **技术栈统一** - 统一使用Spring Boot框架
4. **可扩展性** - 支持独立部署和扩容

### 微服务划分

#### 1. 用户服务 (User Service)
**端口**: 8001
**职责**: 用户认证、权限管理、用户信息管理
**数据库**: user_db
```
功能范围:
- 用户注册/登录/登出
- JWT Token管理
- 用户个人信息管理
- 用户权限控制
- 第三方登录集成
```

#### 2. 知识库服务 (Knowledge Service)
**端口**: 8002
**职责**: 知识库管理、知识区管理、知识点CRUD
**数据库**: knowledge_db
```
功能范围:
- 知识库的创建、编辑、删除
- 知识区的管理
- 知识点的CRUD操作
- 知识点笔记和评分管理
- 知识库导入导出
- 知识点搜索和筛选
```

#### 3. 答题服务 (Practice Service)
**端口**: 8003
**职责**: 题目生成、复习计划、答题记录
**数据库**: practice_db
```
功能范围:
- 题目列表生成算法
- SM-2智能复习算法
- 复习计划管理
- 答题会话管理
- 复习记录存储
- 复习统计分析
```

#### 4. 错题本服务 (Mistake Service)
**端口**: 8004
**职责**: 错题记录、错题分析、掌握度追踪
**数据库**: mistake_db
```
功能范围:
- 错题自动收集
- 错题分类管理
- 掌握度状态管理
- 错题复习计划
- 错题统计分析
```

#### 5. 统计分析服务 (Analytics Service)
**端口**: 8005
**职责**: 学习数据统计、报表生成、数据分析
**数据库**: analytics_db
```
功能范围:
- 学习数据收集
- 统计报表生成
- 学习趋势分析
- 成就系统
- 数据导出
```

#### 6. 知识库广场服务 (Community Service)
**端口**: 8006
**职责**: 知识库分享、下载、评价、社区功能
**数据库**: community_db
```
功能范围:
- 知识库发布和分享
- 知识库评价和评论
- 知识库推荐算法
- 用户关注和收藏
- 社区活动管理
```

#### 7. API网关 (Gateway Service)
**端口**: 8000
**职责**: 请求路由、负载均衡、认证鉴权、限流
```
功能范围:
- 统一入口管理
- 路由转发
- 认证鉴权
- 限流熔断
- 日志记录
```

### 技术架构图

```
┌─────────────────────────────────────────────────────────────┐
│                        前端层                                │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │
│  │   Web页面   │ │  移动端H5   │ │   管理端    │           │
│  └─────────────┘ └─────────────┘ └─────────────┘           │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      API网关层                               │
│              Spring Cloud Gateway (8000)                   │
│              ┌─认证鉴权─┐ ┌─路由转发─┐ ┌─限流熔断─┐          │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                       微服务层                               │
│ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐        │
│ │用户服务  │ │知识库服务│ │答题服务  │ │错题本服务│        │
│ │  8001    │ │  8002    │ │  8003    │ │  8004    │        │
│ └──────────┘ └──────────┘ └──────────┘ └──────────┘        │
│ ┌──────────┐ ┌──────────┐                                 │
│ │统计服务  │ │广场服务  │                                 │
│ │  8005    │ │  8006    │                                 │
│ └──────────┘ └──────────┘                                 │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      基础设施层                              │
│ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐        │
│ │  MySQL   │ │  Redis   │ │  Nacos   │ │RabbitMQ  │        │
│ │   数据   │ │   缓存   │ │  注册    │ │  消息    │        │
│ └──────────┘ └──────────┘ └──────────┘ └──────────┘        │
└─────────────────────────────────────────────────────────────┘
```

## 数据库设计概览

### 数据库分库策略
- **user_db**: 用户相关数据
- **knowledge_db**: 知识库相关数据
- **practice_db**: 答题和复习相关数据
- **mistake_db**: 错题相关数据
- **analytics_db**: 统计分析数据
- **community_db**: 社区和广场数据

### 核心数据表设计

#### 用户服务数据表
```sql
-- 用户基本信息表
users(id, username, email, password, avatar, created_at, updated_at)

-- 用户配置表
user_settings(user_id, theme, language, notification, created_at)
```

#### 知识库服务数据表
```sql
-- 知识库表
knowledge_bases(id, user_id, name, description, is_public, created_at)

-- 知识区表
knowledge_areas(id, base_id, name, description, color, sort_order, created_at)

-- 知识点表
knowledge_points(id, area_id, question, answer, explanation, note, score, tags, difficulty, created_at)
```

#### 答题服务数据表
```sql
-- 复习会话表
review_sessions(id, user_id, session_type, config, status, created_at)

-- 复习记录表
review_records(id, user_id, knowledge_id, session_id, is_correct, rating, time_spent, created_at)
```

#### 错题本服务数据表
```sql
-- 错题记录表
mistake_records(id, user_id, knowledge_id, mistake_count, is_resolved, created_at, resolved_at)
```

## 服务间通信设计

### 通信方式
1. **同步通信**: REST API + OpenFeign
2. **异步通信**: RabbitMQ消息队列
3. **数据一致性**: 最终一致性 + 补偿机制

### 服务依赖关系
```
用户服务 ← API网关 → 所有服务 (认证依赖)
知识库服务 ← 答题服务 (获取知识点)
知识库服务 ← 错题本服务 (获取知识点信息)
答题服务 → 错题本服务 (错题记录)
所有业务服务 → 统计分析服务 (数据上报)
知识库服务 ← 广场服务 (知识库分享)
```

### 消息队列事件设计
```yaml
事件类型:
  - user.registered: 用户注册事件
  - knowledge.created: 知识点创建事件
  - practice.completed: 答题完成事件
  - mistake.added: 错题添加事件
  - mistake.resolved: 错题解决事件
```

## 前端适配方案

### API接口适配
将当前前端的LocalStorage操作替换为HTTP API调用：
```javascript
// 原来的本地存储
localStorage.setItem('memorin_data', JSON.stringify(data));

// 改为API调用
await fetch('/api/knowledge/save', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify(data)
});
```

### 状态管理改造
1. **用户状态**: 添加登录状态管理
2. **数据缓存**: 使用前端缓存减少API调用
3. **离线支持**: Service Worker + IndexedDB
4. **错误处理**: 统一的API错误处理

### 用户体验保持
1. **响应速度**: 关键数据预加载和缓存
2. **离线能力**: 核心功能离线可用
3. **界面一致性**: 保持现有的UI设计和交互
4. **渐进增强**: 逐步添加新功能

## 部署架构

### 容器化部署
```yaml
services:
  - nginx (前端静态资源)
  - gateway (API网关)
  - user-service (用户服务)
  - knowledge-service (知识库服务)
  - practice-service (答题服务)
  - mistake-service (错题本服务)
  - analytics-service (统计服务)
  - community-service (广场服务)
  - mysql (数据库)
  - redis (缓存)
  - nacos (服务注册)
  - rabbitmq (消息队列)
```

### 开发环境
- **本地开发**: Docker Compose一键启动
- **服务发现**: Nacos本地实例
- **数据库**: 本地MySQL + Redis

### 生产环境
- **容器编排**: Kubernetes
- **负载均衡**: Nginx + Spring Cloud Gateway
- **数据库**: MySQL主从 + Redis集群
- **监控告警**: Prometheus + Grafana

## 开发计划

### 阶段一：基础设施搭建 (1-2周)
1. 搭建微服务基础框架
2. 配置服务注册与发现
3. 设置API网关
4. 建立数据库和消息队列

### 阶段二：核心服务开发 (3-4周)
1. 用户服务开发和测试
2. 知识库服务开发和测试
3. 答题服务开发和测试
4. 错题本服务开发和测试

### 阶段三：扩展功能开发 (2-3周)
1. 统计分析服务开发
2. 知识库广场服务开发
3. 前端API接口适配

### 阶段四：集成测试和优化 (1-2周)
1. 系统集成测试
2. 性能优化
3. 部署脚本完善

## 技术风险和解决方案

### 数据一致性风险
**风险**: 分布式环境下的数据一致性问题
**方案**: 
- 使用分布式事务框架(Seata)
- 设计补偿机制
- 实现幂等性接口

### 服务可用性风险
**风险**: 单个服务故障影响整体功能
**方案**:
- 服务熔断和降级
- 健康检查和自动重启
- 核心功能的本地缓存

### 性能风险
**风险**: 微服务调用链路过长影响性能
**方案**:
- 合理的缓存策略
- 异步处理非关键流程
- 数据库读写分离

这个架构设计文档为后续的详细开发文档提供了整体框架。接下来我将逐个编写每个服务的详细开发文档。您觉得这个整体架构设计如何？有什么需要调整或补充的地方吗？ 