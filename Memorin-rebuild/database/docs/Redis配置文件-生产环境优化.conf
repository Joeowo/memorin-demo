# Memorin Redis生产环境配置
# 基于Redis 7.0+版本
# 针对智能知识复习系统优化

################################## NETWORK #####################################

# 监听地址
bind 0.0.0.0

# 端口
port 6379

# TCP监听队列长度
tcp-backlog 511

# 客户端连接超时设置
timeout 0

# TCP keepalive
tcp-keepalive 300

################################# TLS/SSL ######################################

# 如果需要SSL支持，取消下面注释并配置证书
# port 0
# tls-port 6380
# tls-cert-file /path/to/redis.crt
# tls-key-file /path/to/redis.key
# tls-ca-cert-file /path/to/ca.crt

################################# GENERAL #####################################

# 以守护进程方式运行
daemonize yes

# 进程文件
pidfile /var/run/redis_6379.pid

# 日志级别
loglevel notice

# 日志文件
logfile /var/log/redis/redis-server.log

# 数据库数量
databases 16

# 数据库文件名
dbfilename memorin-dump.rdb

# 工作目录
dir /var/lib/redis

################################ SNAPSHOTTING  ################################

# RDB持久化规则
# 900秒内至少1个key改变
save 900 1
# 300秒内至少10个key改变
save 300 10
# 60秒内至少10000个key改变
save 60 10000

# RDB文件保存失败时停止写入
stop-writes-on-bgsave-error yes

# RDB文件压缩
rdbcompression yes

# RDB文件校验
rdbchecksum yes

# RDB文件备份目录
# 用于备份恢复
backup-dir /var/backups/redis

################################# REPLICATION #################################

# 主从复制配置
# 作为从服务器时，指定主服务器
# replicaof <masterip> <masterport>

# 主服务器认证密码
# masterauth <master-password>

# 从服务器只读
replica-read-only yes

# 复制超时时间
repl-timeout 60

# 复制ping间隔
repl-ping-replica-period 10

# 复制缓冲区大小
repl-backlog-size 64mb

# 复制缓冲区超时
repl-backlog-ttl 3600

# 从服务器优先级
replica-priority 100

# 最小从服务器数量
# min-replicas-to-write 1
# min-replicas-max-lag 10

################################## SECURITY ###################################

# 用户认证
# requirepass your_redis_password

# 重命名危险命令
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command CONFIG "CONFIG_b7f2c3d4e5f6"

# ACL配置文件
# aclfile /etc/redis/users.acl

################################### CLIENTS ####################################

# 最大客户端连接数
maxclients 10000

################################## MEMORY MANAGEMENT #########################

# 最大内存限制 (8GB)
maxmemory 8gb

# 内存淘汰策略
# allkeys-lru: 在所有键中使用LRU算法删除
maxmemory-policy allkeys-lru

# 内存淘汰样本数
maxmemory-samples 5

# 在主从复制时，从服务器也执行内存淘汰
replica-ignore-maxmemory no

################################ LAZY FREEING ################################

# 惰性删除配置
lazyfree-lazy-eviction yes
lazyfree-lazy-expire yes
lazyfree-lazy-server-del yes
replica-lazy-flush yes

# 惰性删除用户删除
lazyfree-lazy-user-del no

############################ KERNEL OOM CONTROL ##############################

# OOM控制
oom-score-adj no

# OOM控制值
# oom-score-adj-values 0 200 800

#################### KERNEL TRANSPARENT HUGEPAGE CONTROL ######################

# 透明大页控制
disable-thp yes

############################## APPEND ONLY FILE ###############################

# AOF持久化
appendonly yes

# AOF文件名
appendfilename "memorin-appendonly.aof"

# AOF同步策略
appendfsync everysec

# AOF重写时不同步
no-appendfsync-on-rewrite no

# AOF重写阈值
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# AOF加载截断处理
aof-load-truncated yes

# 混合持久化
aof-use-rdb-preamble yes

# AOF时间戳
aof-timestamp-enabled no

################################ SHUTDOWN #####################################

# 关闭超时
shutdown-timeout 10

# 关闭时保存数据
shutdown-on-sigint nosave
shutdown-on-sigterm save

################ NON-DETERMINISTIC LONG BLOCKING COMMANDS #####################

# Lua脚本超时
lua-time-limit 5000

################################## SLOW LOG ###################################

# 慢查询日志
slowlog-log-slower-than 10000
slowlog-max-len 128

################################ LATENCY MONITOR ##############################

# 延迟监控
latency-monitor-threshold 100

################################## GOPHER SERVER #############################

# Gopher协议支持
# gopher-enabled no

############################### ADVANCED CONFIG #############################

# 哈希表配置
hash-max-ziplist-entries 512
hash-max-ziplist-value 64

# 列表压缩配置
list-max-ziplist-size -2
list-compress-depth 0

# 集合配置
set-max-intset-entries 512

# 有序集合配置
zset-max-ziplist-entries 128
zset-max-ziplist-value 64

# HyperLogLog配置
hll-sparse-max-bytes 3000

# 流配置
stream-node-max-bytes 4096
stream-node-max-entries 100

# 自动rehash
activerehashing yes

# 客户端输出缓冲区限制
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

# 客户端查询缓冲区限制
client-query-buffer-limit 1gb

# 协议缓冲区限制
proto-max-bulk-len 512mb

# 频率限制
hz 10

# 自适应频率
dynamic-hz yes

# AOF重写增量缓冲区
aof-rewrite-incremental-fsync yes

# RDB保存增量同步
rdb-save-incremental-fsync yes

# LFU对数因子
lfu-log-factor 10

# LFU衰减时间
lfu-decay-time 1

########################### ACTIVE DEFRAGMENTATION #######################

# 内存碎片整理
activedefrag no

# 碎片整理阈值
active-defrag-ignore-bytes 100mb
active-defrag-threshold-lower 10

# 碎片整理CPU使用率
active-defrag-cycle-min 1
active-defrag-cycle-max 25

# 碎片整理最大扫描字段
active-defrag-max-scan-fields 1000

# Jemalloc特定配置
jemalloc-bg-thread yes

# 过期键处理
hz 10

# RDB文件检查
rdb-del-sync-files no

############################ REDIS CLUSTER  ###############################

# 集群配置
# cluster-enabled yes
# cluster-config-file nodes-6379.conf
# cluster-node-timeout 15000
# cluster-replica-validity-factor 10
# cluster-migration-barrier 1
# cluster-require-full-coverage yes
# cluster-replica-no-failover no
# cluster-allow-reads-when-down no

############################# REDIS MODULES  ###############################

# 模块加载
# loadmodule /path/to/my_module.so
# loadmodule /path/to/other_module.so

########################## MEMORY USAGE OPTIMIZATION ######################

# 内存使用优化配置

# 启用内存统计
track-memory-usage yes

# 内存效率模式
memory-usage-limit 7gb

# 键过期检查频率
active-expire-effort 1

# 键值对象共享
object-frequency-counter yes

########################## MEMORIN SPECIFIC CONFIG #########################

# Memorin业务相关配置

# 键空间通知 - 用于缓存失效
notify-keyspace-events "Ex"

# 事务和Lua脚本配置
lua-time-limit 60000

# 发布订阅配置
pubsub-client-output-buffer-limit 64mb 16mb 60

# 自定义命令别名
# rename-command GET MEMORIN_GET
# rename-command SET MEMORIN_SET
# rename-command DEL MEMORIN_DEL

# 监控和调试
include /etc/redis/redis-monitoring.conf

############################ BACKUP AND RECOVERY ##########################

# 备份配置
save 3600 1 1800 10 300 100

# 备份文件格式
rdbcompression yes
rdbchecksum yes

# 备份目录权限
# 确保redis用户有写权限
# chown redis:redis /var/backups/redis
# chmod 750 /var/backups/redis

############################ PERFORMANCE TUNING ###########################

# 性能调优配置

# TCP无延迟
tcp-nodelay yes

# 关闭保护模式 (仅限内网环境)
protected-mode no

# 开启多线程I/O
io-threads 4
io-threads-do-reads yes

# 开启多线程处理
multi-threaded yes

# TLS配置优化
tls-ciphers "ECDHE+AESGCM:ECDHE+CHACHA20:DHE+AESGCM:DHE+CHACHA20:!aNULL:!MD5:!DSS"
tls-ciphersuites "TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256"

############################ LOGGING AND MONITORING ####################

# 扩展日志配置
syslog-enabled yes
syslog-ident redis
syslog-facility local0

# 慢查询日志文件
slowlog-file /var/log/redis/slow.log

# 延迟日志
latency-tracking yes
latency-tracking-info-percentiles 50 95 99

# 命令统计
track-command-times yes

# 客户端统计
client-default-resp 3

############################ HEALTHCHECK CONFIG ########################

# 健康检查配置
ping-interval 30
ping-timeout 10

# 内存健康检查
memory-check-interval 60
memory-warning-threshold 85
memory-critical-threshold 95

# 连接健康检查
connection-check-interval 30
max-connection-check-failures 3

############################ CUSTOM MEMORIN SETTINGS ###################

# Memorin系统特定优化

# 用户会话缓存优化
user-session-ttl 86400
user-online-ttl 1800

# 知识点内容缓存优化
knowledge-content-ttl 604800
knowledge-choice-ttl 604800

# 热点数据缓存优化
hotspot-threshold 100
hotspot-update-interval 600

# 统计数据缓存优化
stats-cache-ttl 300
global-stats-ttl 86400

# 复习队列缓存优化
review-queue-ttl 43200
user-session-ttl 7200

# 访问计数器配置
access-counter-ttl 3600
access-counter-batch-size 10

# 缓存预热配置
warmup-popular-kb-count 20
warmup-hot-content-count 50

# 缓存清理配置
cleanup-low-access-threshold 5
cleanup-expired-session-threshold 1800

############################ MONITORING INTEGRATION ####################

# Prometheus监控集成
prometheus-enabled yes
prometheus-port 9121

# 监控指标导出
metrics-export-interval 60

# 自定义监控标签
monitoring-labels "service=memorin,env=production,role=cache"

# 告警配置
alert-memory-threshold 85
alert-connection-threshold 8000
alert-hit-rate-threshold 80
alert-hotspot-threshold 10000

# 监控日志
monitoring-log-file /var/log/redis/monitoring.log
monitoring-log-level info

############################ END OF CONFIG #############################

# 配置文件版本信息
# Config Version: 2.0
# Optimized for: Memorin Knowledge Review System
# Redis Version: 7.0+
# Last Modified: 2025-01-08
# 
# 注意事项:
# 1. 请根据实际硬件配置调整内存限制
# 2. 生产环境请启用认证和TLS
# 3. 定期备份配置文件和数据
# 4. 监控系统资源使用情况
# 5. 根据业务负载调整参数 